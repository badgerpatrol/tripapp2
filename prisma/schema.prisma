// Prisma schema for TripPlanner
// Mobile-first trip planner with collaborative spending, assignments, and settlement

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  VIEWER
  USER
  ADMIN
  SUPERADMIN
}

enum SubscriptionTier {
  FREE
  PREMIUM
  ENTERPRISE
}

enum TripStatus {
  PLANNING
  ACTIVE
  FINALIZED
  SETTLED
}

enum TripMemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum RsvpStatus {
  PENDING
  ACCEPTED
  DECLINED
  MAYBE
}

enum SplitType {
  EQUAL
  PERCENTAGE
  EXACT
  SHARE
}

enum SpendStatus {
  OPEN
  CLOSED
}

enum RsvpWindowStatus {
  OPEN
  CLOSED
}

enum SettlementStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  VERIFIED
}

enum ChoiceStatus {
  OPEN
  CLOSED
}

enum ChoiceVisibility {
  TRIP
  PRIVATE
}

enum NotificationType {
  TRIP_INVITE
  SPEND_ADDED
  SPEND_UPDATED
  SPEND_DELETED
  ASSIGNMENT_CHANGED
  SETTLEMENT_REQUESTED
  PAYMENT_RECEIVED
  PAYMENT_VERIFIED
  CHECKLIST_ASSIGNED
  TRIP_FINALIZED
  SYSTEM
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum Visibility {
  PRIVATE
  PUBLIC
}

enum ListType {
  TODO
  KIT
}

enum TodoActionType {
  CREATE_CHOICE
  SET_MILESTONE
  INVITE_USERS
}

enum MilestoneTriggerType {
  MANUAL
  DEADLINE
}

enum GroupMemberRole {
  ADMIN
  MEMBER
}

enum TagEntityType {
  spend
  checklist_item
  kit_item
}

enum LogSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
}

enum EventType {
  USER_CREATED
  USER_UPDATED
  USER_SIGNED_IN
  TRIP_CREATED
  TRIP_UPDATED
  TRIP_DELETED
  SPEND_CREATED
  SPEND_UPDATED
  SPEND_CLOSED
  SPEND_DELETED
  SPEND_ITEM_CREATED
  SPEND_ITEM_UPDATED
  SPEND_ITEM_DELETED
  ASSIGNMENT_CREATED
  ASSIGNMENT_UPDATED
  ASSIGNMENT_DELETED
  ASSIGNMENT_MOVED
  SETTLEMENT_CREATED
  SETTLEMENT_UPDATED
  PAYMENT_RECORDED
  CHECKLIST_CREATED
  CHECKLIST_ITEM_COMPLETED
  MILESTONE_CREATED
  CHOICE_CREATED
  CHOICE_UPDATED
  CHOICE_CLOSED
  CHOICE_REOPENED
  CHOICE_ARCHIVED
  CHOICE_RESTORED
  CHOICE_ITEM_CREATED
  CHOICE_ITEM_UPDATED
  CHOICE_ITEM_DEACTIVATED
  CHOICE_SELECTION_CREATED
  CHOICE_SELECTION_UPDATED
  CHOICE_SELECTION_DELETED
  LIST_TEMPLATE_CREATED
  LIST_TEMPLATE_UPDATED
  LIST_TEMPLATE_DELETED
  LIST_TEMPLATE_PUBLISHED
  LIST_TEMPLATE_UNPUBLISHED
  LIST_TEMPLATE_FORKED
  LIST_TEMPLATE_COPIED_TO_TRIP
  LIST_INSTANCE_CREATED
  LIST_INSTANCE_REPLACED
  LIST_INSTANCE_MERGED
  LIST_INSTANCE_DELETED
  LIST_ITEM_TOGGLED
  LIST_ITEM_ADDED
  LIST_ITEM_REMOVED
  LIST_ITEM_EDITED
  LIST_ITEM_ACTION_LAUNCHED
  CHOICE_MENU_SCANNED
  CHOICE_ITEMS_BULK_ADD
  RECEIPT_SCANNED
  PHOTO_SCANNED
  GROUP_CREATED
  GROUP_UPDATED
  GROUP_DELETED
  GROUP_MEMBER_ADDED
  GROUP_MEMBER_REMOVED
  TAG_ADDED
  TAG_REMOVED
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id          String   @id // Firebase UID
  email       String   @unique
  displayName String
  photoURL    String?
  phoneNumber String?
  role        UserRole @default(USER)
  subscription SubscriptionTier @default(FREE)
  timezone    String?  @default("UTC")
  language    String?  @default("en")
  defaultCurrency String? @default("GBP")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relationships
  tripsCreated       Trip[]            @relation("TripCreator")
  tripsAsSignUpViewer Trip[]           @relation("TripSignUpViewer")
  tripMemberships    TripMember[]
  spendsCreated      Spend[]           @relation("SpendPayer")
  spendAssignments   SpendAssignment[]
  spendItemsCreated  SpendItem[]       @relation("ItemCreator")
  spendItemsAssigned SpendItem[]       @relation("ItemAssignedUser")
  settlementsFrom    Settlement[]      @relation("SettlementFrom")
  settlementsTo      Settlement[]      @relation("SettlementTo")
  paymentsRecorded   Payment[]
  timelineItemsCreated TimelineItem[]
  checklistsCreated  Checklist[]
  checklistItemsCompleted ChecklistItem[] @relation("ChecklistItemCompleter")
  checklistItemsAssigned  ChecklistItem[] @relation("ChecklistItemAssignee")
  eventLogs          EventLog[]
  invitationsSent    Invitation[]
  notificationsSent  Notification[]    @relation("NotificationSender")
  notificationsReceived Notification[] @relation("NotificationRecipient")
  categoriesCreated  Category[]
  featureFlags       FeatureFlag[]
  choicesCreated     Choice[]          @relation("ChoiceCreator")
  choiceSelections   ChoiceSelection[]

  passkeys           Passkey[]

  groupsOwned        Group[]           @relation("GroupOwner")
  groupMemberships   GroupMember[]
  listTemplatesCreated ListTemplate[]

  @@index([email])
  @@map("users")
}

model Passkey {
  id                   String   @id @default(uuid())
  userId               String
  credentialID         String   @unique
  credentialPublicKey  String
  counter              Int      @default(0)
  transports           String[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("passkeys")
}

// ============================================================================
// TRIP & MEMBERSHIP
// ============================================================================

model Trip {
  id           String      @id @default(uuid())
  name         String
  description  String?
  baseCurrency String      @default("USD")
  startDate    DateTime?
  endDate      DateTime?
  status       TripStatus  @default(PLANNING)
  spendStatus  SpendStatus @default(OPEN) // Controls whether any spend can be added/edited on this trip
  rsvpStatus   RsvpWindowStatus @default(OPEN) // Controls whether RSVPs can be changed
  signUpMode   Boolean     @default(false) // When true, creates a viewer user for sign-up access
  signUpViewerUserId String? // The viewer user created for sign-up mode
  signUpPassword String?    // Password for the sign-up viewer account
  createdById  String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime?

  // Relationships
  createdBy    User           @relation("TripCreator", fields: [createdById], references: [id])
  signUpViewerUser User?      @relation("TripSignUpViewer", fields: [signUpViewerUserId], references: [id])
  members      TripMember[]
  spends       Spend[]
  settlements  Settlement[]
  timelineItems TimelineItem[]
  checklists   Checklist[]
  eventLogs    EventLog[]
  invitations  Invitation[]
  notifications Notification[]
  featureFlags FeatureFlag[]
  choices      Choice[]

  @@index([createdById])
  @@index([status])
  @@index([startDate])
  @@map("trips")
}

model TripMember {
  id          String         @id @default(uuid())
  tripId      String
  userId      String
  role        TripMemberRole @default(MEMBER)
  rsvpStatus  RsvpStatus     @default(PENDING)
  joinedAt    DateTime       @default(now())
  invitedById String?
  deletedAt   DateTime?

  // Relationships
  trip  Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([userId])
  @@index([tripId])
  @@index([rsvpStatus])
  @@map("trip_members")
}

model Invitation {
  id          String    @id @default(uuid())
  tripId      String
  email       String
  invitedById String
  token       String    @unique @default(uuid())
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())

  // Relationships
  trip      Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  invitedBy User @relation(fields: [invitedById], references: [id])

  @@index([tripId])
  @@index([email])
  @@index([token])
  @@map("invitations")
}

// ============================================================================
// CATEGORIES
// ============================================================================

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  icon        String?
  color       String?
  isDefault   Boolean   @default(false)
  createdById String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relationships
  createdBy User?   @relation(fields: [createdById], references: [id])
  spends    Spend[]

  @@index([isDefault])
  @@index([createdById])
  @@map("categories")
}

// ============================================================================
// SPENDING & ASSIGNMENTS
// ============================================================================

model Spend {
  id               String      @id @default(uuid())
  tripId           String
  description      String
  amount           Decimal     @db.Decimal(19, 4)
  currency         String      @default("USD")
  fxRate           Decimal     @default(1.0) @db.Decimal(19, 6)
  normalizedAmount Decimal     @db.Decimal(19, 4) // In trip base currency
  paidById         String
  categoryId       String?
  date             DateTime    @default(now())
  status           SpendStatus @default(OPEN)
  receiptUrl       String?
  receiptImageData String?     @db.Text // Base64 encoded receipt image
  notes            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?

  // Relationships
  trip        Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)
  paidBy      User              @relation("SpendPayer", fields: [paidById], references: [id])
  category    Category?         @relation(fields: [categoryId], references: [id])
  assignments SpendAssignment[]
  items       SpendItem[]

  @@index([tripId])
  @@index([paidById])
  @@index([categoryId])
  @@index([date])
  @@index([status])
  @@index([deletedAt])
  @@map("spends")
}

model SpendItem {
  id               String    @id @default(uuid())
  spendId          String
  name             String    // Item name (e.g., "Beer", "Pizza slice")
  description      String?   // Optional description (0-280 chars)
  cost             Decimal   @db.Decimal(19, 4) // Item cost in spend currency
  assignedUserId   String?   // Optional: user assigned to this item
  createdById      String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relationships
  spend        Spend             @relation(fields: [spendId], references: [id], onDelete: Cascade)
  assignedUser User?             @relation("ItemAssignedUser", fields: [assignedUserId], references: [id])
  createdBy    User              @relation("ItemCreator", fields: [createdById], references: [id])
  assignments  SpendAssignment[]

  @@index([spendId])
  @@index([assignedUserId])
  @@index([createdById])
  @@map("spend_items")
}

model SpendAssignment {
  id                    String     @id @default(uuid())
  spendId               String
  itemId                String?    // Optional: link to specific SpendItem
  userId                String
  shareAmount           Decimal    @db.Decimal(19, 4) // In spend currency
  normalizedShareAmount Decimal    @db.Decimal(19, 4) // In trip base currency
  splitType             SplitType  @default(EQUAL)
  splitValue            Decimal?   @db.Decimal(19, 6) // For percentage or share-based
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  // Relationships
  spend Spend      @relation(fields: [spendId], references: [id], onDelete: Cascade)
  item  SpendItem? @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spendId, userId])
  @@index([spendId])
  @@index([itemId])
  @@index([userId])
  @@map("spend_assignments")
}

// ============================================================================
// SETTLEMENT & PAYMENTS
// ============================================================================

model Settlement {
  id               String           @id @default(uuid())
  tripId           String
  fromUserId       String
  toUserId         String
  amount           Decimal          @db.Decimal(19, 4) // In trip base currency
  status           SettlementStatus @default(PENDING)
  paymentMethod    String?
  paymentReference String?
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  // Relationships
  trip     Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  fromUser User      @relation("SettlementFrom", fields: [fromUserId], references: [id])
  toUser   User      @relation("SettlementTo", fields: [toUserId], references: [id])
  payments Payment[]

  @@index([tripId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@map("settlements")
}

model Payment {
  id               String    @id @default(uuid())
  settlementId     String
  amount           Decimal   @db.Decimal(19, 4) // In trip base currency
  paidAt           DateTime  @default(now())
  verifiedAt       DateTime?
  paymentMethod    String?
  paymentReference String?
  notes            String?
  recordedById     String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relationships
  settlement Settlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  recordedBy User       @relation(fields: [recordedById], references: [id])

  @@index([settlementId])
  @@index([paidAt])
  @@index([verifiedAt])
  @@map("payments")
}

// ============================================================================
// TIMELINE
// ============================================================================

model TimelineItem {
  id          String                 @id @default(uuid())
  tripId      String
  title       String
  description String?
  date        DateTime?
  isCompleted Boolean                @default(false)
  completedAt DateTime?
  triggerType MilestoneTriggerType?  // How milestone was triggered (MANUAL or DEADLINE)
  order       Int                    @default(0)
  choiceId    String?                // Optional link to a Choice (for choice-specific deadlines)
  createdById String
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  deletedAt   DateTime?

  // Relationships
  trip      Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy User    @relation(fields: [createdById], references: [id])
  choice    Choice? @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([date])
  @@index([createdById])
  @@index([choiceId])
  @@map("timeline_items")
}

// ============================================================================
// CHECKLISTS
// ============================================================================

model Checklist {
  id          String    @id @default(uuid())
  tripId      String
  title       String
  description String?
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relationships
  trip      Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy User            @relation(fields: [createdById], references: [id])
  items     ChecklistItem[]

  @@index([tripId])
  @@index([createdById])
  @@map("checklists")
}

model ChecklistItem {
  id            String    @id @default(uuid())
  checklistId   String
  text          String
  isCompleted   Boolean   @default(false)
  completedById String?
  completedAt   DateTime?
  assignedToId  String?
  dueDate       DateTime?
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Relationships
  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  completedBy User?     @relation("ChecklistItemCompleter", fields: [completedById], references: [id])
  assignedTo  User?     @relation("ChecklistItemAssignee", fields: [assignedToId], references: [id])

  @@index([checklistId])
  @@index([assignedToId])
  @@index([isCompleted])
  @@map("checklist_items")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id           String             @id @default(uuid())
  recipientId  String
  senderId     String?
  tripId       String?
  type         NotificationType
  status       NotificationStatus @default(UNREAD)
  title        String
  message      String
  actionUrl    String?
  metadata     Json?
  createdAt    DateTime           @default(now())
  readAt       DateTime?
  archivedAt   DateTime?

  // Relationships
  recipient User  @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  sender    User? @relation("NotificationSender", fields: [senderId], references: [id])
  trip      Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([status])
  @@index([createdAt])
  @@index([tripId])
  @@map("notifications")
}

// ============================================================================
// AUDIT & EVENT LOG
// ============================================================================

model EventLog {
  id         String    @id @default(uuid())
  entity     String    // "Trip", "Spend", "Settlement", etc.
  entityId   String
  eventType  EventType
  byUser     String    // User who triggered the event
  tripId     String?
  payload    Json?
  createdAt  DateTime  @default(now())

  // Relationships
  user User  @relation(fields: [byUser], references: [id])
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([entity, entityId])
  @@index([tripId])
  @@index([byUser])
  @@index([createdAt])
  @@map("event_logs")
}

// ============================================================================
// FEATURE FLAGS (Premium features)
// ============================================================================

model FeatureFlag {
  id        String    @id @default(uuid())
  userId    String?
  tripId    String?
  flagKey   String    // "receipt_ocr", "receipt_translation", etc.
  isEnabled Boolean   @default(false)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relationships
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([userId, tripId, flagKey])
  @@index([flagKey])
  @@index([userId])
  @@index([tripId])
  @@map("feature_flags")
}

// ============================================================================
// CHOICES (Menu voting/selection system)
// ============================================================================

model Choice {
  id          String            @id @default(uuid())
  tripId      String
  name        String
  description String?
  datetime    DateTime?
  place       String?
  visibility  ChoiceVisibility  @default(TRIP)
  status      ChoiceStatus      @default(OPEN)
  deadline    DateTime?
  createdById String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  archivedAt  DateTime?

  // Relationships
  trip          Trip               @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy     User               @relation("ChoiceCreator", fields: [createdById], references: [id])
  items         ChoiceItem[]
  selections    ChoiceSelection[]
  activities    ChoiceActivity[]
  timelineItems TimelineItem[]

  @@index([tripId])
  @@index([createdById])
  @@index([status])
  @@index([archivedAt])
  @@map("choices")
}

model ChoiceItem {
  id          String    @id @default(uuid())
  choiceId    String
  name        String
  description String?
  price       Decimal?  @db.Decimal(19, 4)
  course      String?   // Raw course value if present (e.g., "Starters", "Mains", "Desserts")
  sortIndex   Int       @default(0) // For manual reordering or auto-ordering by course
  tags        Json?     // Array of strings
  maxPerUser  Int?
  maxTotal    Int?
  allergens   Json?     // Array of strings
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  choice Choice                 @relation(fields: [choiceId], references: [id], onDelete: Cascade)
  lines  ChoiceSelectionLine[]

  @@index([choiceId])
  @@index([isActive])
  @@map("choice_items")
}

model ChoiceSelection {
  id        String    @id @default(uuid())
  choiceId  String
  userId    String
  note      String?   // Overall note for this user's order
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relationships
  choice Choice                 @relation(fields: [choiceId], references: [id], onDelete: Cascade)
  user   User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lines  ChoiceSelectionLine[]

  @@unique([choiceId, userId])
  @@index([choiceId])
  @@index([userId])
  @@map("choice_selections")
}

model ChoiceSelectionLine {
  id          String    @id @default(uuid())
  selectionId String
  itemId      String
  quantity    Int
  note        String?   // Per-line note (e.g., "no nuts")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  selection ChoiceSelection @relation(fields: [selectionId], references: [id], onDelete: Cascade)
  item      ChoiceItem      @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([selectionId])
  @@index([itemId])
  @@map("choice_selection_lines")
}

model ChoiceActivity {
  id        String    @id @default(uuid())
  choiceId  String
  actorId   String
  action    String    // "created", "updated", "closed", "reopened", etc.
  payload   Json?
  createdAt DateTime  @default(now())

  // Relationships
  choice Choice @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@index([choiceId])
  @@index([actorId])
  @@index([createdAt])
  @@map("choice_activities")
}

// ============================================================================
// LISTS PLATFORM (TODO & KIT lists)
// ============================================================================

model ListTemplate {
  id                   String     @id @default(cuid())
  ownerId              String
  title                String
  description          String?
  type                 ListType
  visibility           Visibility @default(PRIVATE)
  publishedAt          DateTime?
  forkedFromTemplateId String?
  tags                 String[]   @default([])
  isTripTemplate       Boolean    @default(false)
  inventory            Boolean    @default(false) // If true, shows in inventory section
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  // Relations
  owner     User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  todoItems TodoItemTemplate[]
  kitItems  KitItemTemplate[]

  @@index([ownerId, visibility])
  @@index([visibility, type, title])
  @@index([forkedFromTemplateId])
  @@index([isTripTemplate])
  @@index([inventory])
  @@map("list_templates")
}

model ListInstance {
  id               String   @id @default(cuid())
  tripId           String
  type             ListType
  sourceTemplateId String?
  title            String
  description      String?
  inventory        Boolean  @default(false) // If true, shows in inventory section
  createdBy        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Per-type item relations
  todoItems TodoItemInstance[]
  kitItems  KitItemInstance[]

  @@index([tripId, type, title])
  @@index([inventory])
  @@map("list_instances")
}

/********** TODO type items **********/
model TodoItemTemplate {
  id         String          @id @default(cuid())
  templateId String
  label      String
  notes      String?
  actionType TodoActionType?
  actionData Json?
  parameters Json?
  orderIndex Int             @default(0)

  template ListTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("todo_item_templates")
}

model TodoItemInstance {
  id         String          @id @default(cuid())
  listId     String
  label      String
  notes      String?
  isDone     Boolean         @default(false)
  doneBy     String?
  doneAt     DateTime?
  actionType TodoActionType?
  actionData Json?
  parameters Json?
  orderIndex Int             @default(0)

  list ListInstance @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId])
  @@map("todo_item_instances")
}

/********** KIT type items **********/
model KitItemTemplate {
  id          String   @id @default(cuid())
  templateId  String
  label       String
  notes       String?
  quantity    Float    @default(1) // can be fractional
  perPerson   Boolean  @default(false)
  required    Boolean  @default(true)
  weightGrams Int?
  category    String?
  cost        Decimal? @db.Decimal(10, 2)
  url         String?
  orderIndex  Int      @default(0)
  // Inventory-specific fields
  date             DateTime?
  needsRepair      Boolean   @default(false)
  conditionNotes   String?
  lost             Boolean   @default(false)
  lastSeenText     String?
  lastSeenDate     DateTime?

  template ListTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("kit_item_templates")
}

model KitItemInstance {
  id          String    @id @default(cuid())
  listId      String
  label       String
  notes       String?
  quantity    Float     @default(1)
  perPerson   Boolean   @default(false)
  required    Boolean   @default(true)
  weightGrams Int?
  category    String?
  cost        Decimal?  @db.Decimal(10, 2)
  url         String?
  isPacked    Boolean   @default(false)
  packedBy    String?
  packedAt    DateTime?
  orderIndex  Int       @default(0)
  // Inventory-specific fields
  date             DateTime?
  needsRepair      Boolean   @default(false)
  conditionNotes   String?
  lost             Boolean   @default(false)
  lastSeenText     String?
  lastSeenDate     DateTime?

  list ListInstance @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId])
  @@map("kit_item_instances")
}

// ============================================================================
// GROUPS - User-managed contact lists for invitation filtering
// ============================================================================

model Group {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner   User          @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members GroupMember[]

  @@index([ownerId])
  @@map("groups")
}

model GroupMember {
  id       String          @id @default(uuid())
  groupId  String
  userId   String
  role     GroupMemberRole @default(MEMBER)
  joinedAt DateTime        @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

// ============================================================================
// SYSTEM LOGS
// ============================================================================

model SystemLog {
  id         String      @id @default(uuid())
  datetime   DateTime    @default(now())
  severity   LogSeverity
  feature    String      // e.g., "auth", "spend", "trip", "list", etc.
  eventName  String      // e.g., "user_login", "spend_created", etc.
  eventText  String      @db.Text
  metadata   Json?       // Optional additional structured data
  createdAt  DateTime    @default(now())

  @@index([datetime(sort: Desc)])
  @@index([severity])
  @@index([feature])
  @@index([eventName])
  @@map("system_logs")
}

// ============================================================================
// TAGS - Flexible tagging system for spends, checklist items, kit items
// ============================================================================

model Tag {
  id         String    @id @default(uuid())
  name       String    @unique
  slug       String    @unique
  usageCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  links TagLink[]

  @@index([name])
  @@index([slug])
  @@map("tags")
}

model TagLink {
  id         String        @id @default(uuid())
  tagId      String
  entityType TagEntityType
  entityId   String
  createdBy  String
  createdAt  DateTime      @default(now())

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, entityType, entityId])
  @@index([tagId])
  @@index([entityType, entityId])
  @@map("tag_links")
}
